name: Save PR Diff

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  diff:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate PR diff
        run: |
          echo "Fetching base and head SHAs..."
          git fetch origin ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }}
          git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > pr-diff.txt
          echo "==== PR Diff ===="
          cat pr-diff.txt

      - name: Send diff to Lambda API
        env:
          LAMBDA_URL: ${{ secrets.LAMBDA_API_URL }}
          FORWARD_API_URL: 'https://1dcf-14-142-183-182.ngrok-free.app/api/test/execute'
        run: |
          echo "Reading diff into variable..."
          diff_content=$(< pr-diff.txt)

          echo "Building JSON payload and sending to Lambda..."
          payload=$(jq -n \
            --arg pr_number "${{ github.event.pull_request.number }}" \
            --arg repo "${{ github.repository }}" \
            --arg pr_description "${{ github.event.pull_request.body }}" \
            --arg commitSha "${{ github.sha }}" \
            --arg repositoryUrl "https://github.com/${{ github.repository }}" \
            --arg branch "${{ github.head_ref }}" \
            --arg diff "$diff_content" \
            '{
              repository: $repo,
              repositoryUrl: $repositoryUrl,
              pr_number: $pr_number,
              pr_description: $pr_description,
              commitSha: $commitSha,
              branch: $branch,
              diff: $diff
            }')
          
          echo "Sending to Lambda and capturing response..."
          lambda_response=$(curl -s -X POST "$LAMBDA_URL" \
                                -H "Content-Type: application/json" \
                                -d "$payload")

          echo "Forwarding Lambda response to secondary API..."
          curl -X POST "$FORWARD_API_URL" \
              -H "Content-Type: application/json" \
              -d "$lambda_response"


                        